(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function s(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(o){if(o.ep)return;o.ep=!0;const a=s(o);fetch(o.href,a)}})();const H=60;function N(e){return e*Math.PI/180}function k(e){return e*180/Math.PI}function q(e,t,s=H){const n=e>0&&t>0?e/t:1.7777777777777777,o=N(s),a=2*Math.atan(Math.tan(o/2)/n),i=k(a),r=e/s,m=t/i;return Math.max(1,Math.min(r,m))}function R(e){return e<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function u(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055}function p(e){return e<0?0:e>1?1:e}const F={1:{label:"1 month",spatialCutoffCPD:1.5,peakSensitivityCPD:.5,contrastSensitivityPeak:10,contrastSlope:.65,temporalIntegrationMs:200,coneSensitivity:{L:.6,M:.4,S:.15},pupilDiameterMm:2.5,scatteringFactor:.3,accommodationRange:.2,centralFieldRadiusDeg:10,peripheralSuppression:.7,lateralInhibition:.3,photoreceptorNoise:.08,description:"Visual acuity ~20/400 (1.5 cpd cutoff). Minimal blue cone function. High optical scatter. Best focus at 8-10 inches."},2:{label:"2 months",spatialCutoffCPD:2.5,peakSensitivityCPD:1,contrastSensitivityPeak:40,contrastSlope:.75,temporalIntegrationMs:150,coneSensitivity:{L:.85,M:.65,S:.45},pupilDiameterMm:3,scatteringFactor:.2,accommodationRange:.4,centralFieldRadiusDeg:15,peripheralSuppression:.5,lateralInhibition:.5,photoreceptorNoise:.05,description:"Visual acuity ~20/150 (2.5 cpd). S-cones functional. Contrast sensitivity 4-5x improved. Beginning accommodation."},3:{label:"3 months",spatialCutoffCPD:4,peakSensitivityCPD:1.5,contrastSensitivityPeak:60,contrastSlope:.85,temporalIntegrationMs:100,coneSensitivity:{L:.95,M:.85,S:.7},pupilDiameterMm:3.5,scatteringFactor:.1,accommodationRange:.6,centralFieldRadiusDeg:20,peripheralSuppression:.3,lateralInhibition:.7,photoreceptorNoise:.02,description:"Visual acuity 20/60 (4.0 cpd). Good color discrimination. Smooth pursuit tracking. Emerging stereopsis."}};function G(e,t,s,n,o){const a=e.getImageData(0,0,t,s),i=a.data;for(let r=0;r<i.length;r+=4){const m=i[r]/255,d=i[r+1]/255,v=i[r+2]/255,g=R(m),C=R(d),P=R(v),L=.2126*g+.7152*C+.0722*P;if(o===1){const y=g*n.coneSensitivity.L,f=L*.85,S=p(f+y*.25),V=p(f*n.coneSensitivity.M),A=p(f*n.coneSensitivity.S);i[r]=Math.round(u(S)*255),i[r+1]=Math.round(u(V)*255),i[r+2]=Math.round(u(A)*255)}else if(o===2){const y=p(g*n.coneSensitivity.L),f=p(C*n.coneSensitivity.M),S=p(Math.min(P*n.coneSensitivity.S,L*.3));i[r]=Math.round(u(y)*255),i[r+1]=Math.round(u(f)*255),i[r+2]=Math.round(u(S)*255)}else{const y=p(g*n.coneSensitivity.L),f=p(C*n.coneSensitivity.M),S=p(P*n.coneSensitivity.S);i[r]=Math.round(u(y)*255),i[r+1]=Math.round(u(f)*255),i[r+2]=Math.round(u(S)*255)}}e.putImageData(a,0,0)}function W(e,t,s,n){const o=t/2,a=s/2,i=q(t,s),r=Math.max(1,n.centralFieldRadiusDeg*i),m=Math.hypot(t,s)*.5;e.save(),e.globalCompositeOperation="multiply";const d=e.createRadialGradient(o,a,Math.max(1,r*.5),o,a,Math.max(r,m));d.addColorStop(0,"rgba(255,255,255,1)"),d.addColorStop(.5,`rgba(255,255,255,${1-n.peripheralSuppression*.4})`),d.addColorStop(1,`rgba(255,255,255,${1-n.peripheralSuppression})`),e.fillStyle=d,e.fillRect(0,0,t,s),e.restore()}const l=document.getElementById("cameraVideo"),h=document.getElementById("outputCanvas"),w=document.getElementById("infoPanel"),D=document.getElementById("mirrorToggle"),x=document.getElementById("peripheralBlurToggle");let c,M=1,T=!0,$=!0,b=0;function B(e,t){if(console.log("Setting up canvases with dimensions:",e,"x",t),e<=0||t<=0){console.error("Invalid canvas dimensions:",e,t);return}h.width=e,h.height=t,c=h.getContext("2d",{alpha:!1,willReadFrequently:!0}),console.log("Output canvas setup complete. Context:",c),["input","frequency","color","spatial","temporal","final"].forEach(n=>{const o=document.createElement("canvas");o.width=e,o.height=t,o.getContext("2d",{alpha:!1,willReadFrequently:!0})}),console.log("All processing canvases created")}function z(){if(!c){console.error("Output context not available");return}const e=h.width,t=h.height;if(e<=0||t<=0){console.error("Invalid canvas dimensions in processFrame:",e,t);return}if(!l||l.readyState<2){console.log("Video not ready, skipping frame");return}try{c.save(),T&&(c.translate(e,0),c.scale(-1,1));const o=l.videoWidth||e,a=l.videoHeight||t,i=o/a,r=e/t;let m=0,d=0,v=o,g=a;r>i?(g=Math.round(o/r),d=Math.max(0,Math.floor((a-g)/2))):(v=Math.round(a*r),m=Math.max(0,Math.floor((o-v)/2))),c.drawImage(l,m,d,v,g,0,0,e,t),c.restore()}catch(o){console.error("Error drawing video to canvas:",o);return}const s=F[M],n=Math.max(0,(4-M)*2);n>0&&(c.save(),c.filter=`blur(${n}px) contrast(${s.contrastSensitivityPeak*2}%)`,c.drawImage(c.canvas,0,0),c.restore()),G(c,e,t,s,M),$&&W(c,e,t,s),b++,b===1&&console.log("First frame processed successfully!"),b%60===0&&console.log(`Raw camera feed - ${b} frames processed`)}function O(){z(),requestAnimationFrame(O)}function E(){const e=F[M],t=`
    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
      <strong>Scientific Parameters:</strong><br>
      • Spatial cutoff: ${e.spatialCutoffCPD} cpd<br>
      • Contrast sensitivity: ${e.contrastSensitivityPeak}x<br>
      • Cone responses: L=${e.coneSensitivity.L}, M=${e.coneSensitivity.M}, S=${e.coneSensitivity.S}<br>
      • Optical scatter: ${(e.scatteringFactor*100).toFixed(0)}%<br>
      • Central field: ${e.centralFieldRadiusDeg}°
    </div>
  `;w.innerHTML=`
    <strong>${e.label}</strong>: ${e.description}
    ${t}
  `}async function _(){try{console.log("Requesting camera access...");const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}},audio:!1});console.log("Camera stream obtained:",e),l.srcObject=e,await new Promise(o=>{l.readyState>=2?(console.log("Video ready immediately"),o()):(console.log("Waiting for video metadata..."),l.onloadedmetadata=()=>{console.log("Video metadata loaded"),o()})}),console.log("Video dimensions:",l.videoWidth,"x",l.videoHeight),await l.play(),console.log("Video playing started");const t=h.parentElement,s=t.clientWidth,n=t.clientHeight;console.log("Container dimensions:",s,"x",n),B(s,n),E(),O(),console.log("Camera initialization complete")}catch(e){console.error("Camera error:",e),X(e)}}function U(){document.querySelectorAll('input[name="age"]').forEach(e=>{e.addEventListener("change",()=>{M=Number(e.value),E()})}),D.addEventListener("change",()=>{T=D.checked}),x.addEventListener("change",()=>{$=x.checked,E()})}function X(e){const t=document.createElement("div");t.style.background="rgba(255,0,0,0.08)",t.style.border="1px solid rgba(255,0,0,0.25)",t.style.padding="0.75rem",t.style.borderRadius="10px",t.style.marginTop="1rem",t.innerHTML=`
    <strong>Unable to access camera</strong><br>
    Please allow camera permissions and use a supported browser over HTTPS or localhost.<br>
    <small>Error: ${e.message}</small>
  `,w.replaceChildren(t),console.error("Camera error:",e)}function I(){const e=h.parentElement;if(!e)return;const t=e.getBoundingClientRect();B(Math.max(1,Math.floor(t.width)),Math.max(1,Math.floor(t.height)))}function Y(){U(),I(),window.addEventListener("resize",I),console.log("Advanced Baby Vision Simulator initialized"),console.log("Features: CSF-based spatial filtering, LMS color space, optical modeling"),console.log("Research basis: Contrast sensitivity development, cone maturation, optical properties"),_()}document.addEventListener("DOMContentLoaded",Y);
