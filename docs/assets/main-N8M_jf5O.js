(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const u of r.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&s(u)}).observe(document,{childList:!0,subtree:!0});function a(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(o){if(o.ep)return;o.ep=!0;const r=a(o);fetch(o.href,r)}})();const i=document.getElementById("cameraVideo"),l=document.getElementById("outputCanvas"),v=document.getElementById("infoPanel"),g=document.getElementById("mirrorToggle"),p=document.getElementById("peripheralBlurToggle");let n,c=1,y=!0,h=!0,d=0;function C(e,t){if(console.log("Setting up canvases with dimensions:",e,"x",t),e<=0||t<=0){console.error("Invalid canvas dimensions:",e,t);return}l.width=e,l.height=t,n=l.getContext("2d",{alpha:!1,willReadFrequently:!0}),console.log("Output canvas setup complete. Context:",n),["input","frequency","color","spatial","temporal","final"].forEach(s=>{const o=document.createElement("canvas");o.width=e,o.height=t,o.getContext("2d",{alpha:!1,willReadFrequently:!0})}),console.log("All processing canvases created")}function E(){if(!n){console.error("Output context not available");return}const e=l.width,t=l.height;if(e<=0||t<=0){console.error("Invalid canvas dimensions in processFrame:",e,t);return}if(!i||i.readyState<2){console.log("Video not ready, skipping frame");return}try{n.save(),y&&(n.translate(e,0),n.scale(-1,1)),n.drawImage(i,0,0,e,t),n.restore()}catch(o){console.error("Error drawing video to canvas:",o);return}const a=AGE_PRESETS[c],s=Math.max(0,(4-c)*2);s>0&&(n.save(),n.filter=`blur(${s}px) contrast(${a.contrastSensitivityPeak*2}%)`,n.drawImage(n.canvas,0,0),n.restore()),applyInfantColorVision(n,e,t,a,c),h&&applyPeripheralVision(n,e,t,a),d++,d===1&&console.log("First frame processed successfully!"),d%60===0&&console.log(`Raw camera feed - ${d} frames processed`)}function b(){E(),requestAnimationFrame(b)}function m(){const e=AGE_PRESETS[c],t=`
    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
      <strong>Scientific Parameters:</strong><br>
      • Spatial cutoff: ${e.spatialCutoffCPD} cpd<br>
      • Contrast sensitivity: ${e.contrastSensitivityPeak}x<br>
      • Cone responses: L=${e.coneSensitivity.L}, M=${e.coneSensitivity.M}, S=${e.coneSensitivity.S}<br>
      • Optical scatter: ${(e.scatteringFactor*100).toFixed(0)}%<br>
      • Central field: ${e.centralFieldRadiusDeg}°
    </div>
  `;v.innerHTML=`
    <strong>${e.label}</strong>: ${e.description}
    ${t}
  `}async function S(){try{console.log("Requesting camera access...");const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}},audio:!1});console.log("Camera stream obtained:",e),i.srcObject=e,await new Promise(o=>{i.readyState>=2?(console.log("Video ready immediately"),o()):(console.log("Waiting for video metadata..."),i.onloadedmetadata=()=>{console.log("Video metadata loaded"),o()})}),console.log("Video dimensions:",i.videoWidth,"x",i.videoHeight),await i.play(),console.log("Video playing started");const t=l.parentElement,a=t.clientWidth,s=t.clientHeight;console.log("Container dimensions:",a,"x",s),C(a,s),m(),b(),console.log("Camera initialization complete")}catch(e){console.error("Camera error:",e),x(e)}}function w(){document.querySelectorAll('input[name="age"]').forEach(e=>{e.addEventListener("change",()=>{c=Number(e.value),m()})}),g.addEventListener("change",()=>{y=g.checked}),p.addEventListener("change",()=>{h=p.checked,m()})}function x(e){const t=document.createElement("div");t.style.background="rgba(255,0,0,0.08)",t.style.border="1px solid rgba(255,0,0,0.25)",t.style.padding="0.75rem",t.style.borderRadius="10px",t.style.marginTop="1rem",t.innerHTML=`
    <strong>Unable to access camera</strong><br>
    Please allow camera permissions and use a supported browser over HTTPS or localhost.<br>
    <small>Error: ${e.message}</small>
  `,v.replaceChildren(t),console.error("Camera error:",e)}function f(){const e=l.parentElement;if(!e)return;const t=e.getBoundingClientRect();l.style.width=t.width+"px",l.style.height=t.height+"px"}function P(){w(),f(),window.addEventListener("resize",f),console.log("Advanced Baby Vision Simulator initialized"),console.log("Features: CSF-based spatial filtering, LMS color space, optical modeling"),console.log("Research basis: Contrast sensitivity development, cone maturation, optical properties"),S()}document.addEventListener("DOMContentLoaded",P);
