(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function i(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(o){if(o.ep)return;o.ep=!0;const r=i(o);fetch(o.href,r)}})();const A=60;function N(e){return e*Math.PI/180}function k(e){return e*180/Math.PI}function H(e,t,i=A){const n=e>0&&t>0?e/t:1.7777777777777777,o=N(i),r=2*Math.atan(Math.tan(o/2)/n),a=k(r),s=e/i,f=t/a;return Math.max(1,Math.min(s,f))}function P(e){return e<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function l(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055}function d(e){return e<0?0:e>1?1:e}const x={1:{label:"1 month",spatialCutoffCPD:1.5,peakSensitivityCPD:.5,contrastSensitivityPeak:10,contrastSlope:.65,temporalIntegrationMs:200,coneSensitivity:{L:.6,M:.4,S:.15},pupilDiameterMm:2.5,scatteringFactor:.3,accommodationRange:.2,centralFieldRadiusDeg:10,peripheralSuppression:.7,lateralInhibition:.3,photoreceptorNoise:.08,description:"Visual acuity ~20/400 (1.5 cpd cutoff). Minimal blue cone function. High optical scatter. Best focus at 8-10 inches."},2:{label:"2 months",spatialCutoffCPD:2.5,peakSensitivityCPD:1,contrastSensitivityPeak:40,contrastSlope:.75,temporalIntegrationMs:150,coneSensitivity:{L:.85,M:.65,S:.45},pupilDiameterMm:3,scatteringFactor:.2,accommodationRange:.4,centralFieldRadiusDeg:15,peripheralSuppression:.5,lateralInhibition:.5,photoreceptorNoise:.05,description:"Visual acuity ~20/150 (2.5 cpd). S-cones functional. Contrast sensitivity 4-5x improved. Beginning accommodation."},3:{label:"3 months",spatialCutoffCPD:4,peakSensitivityCPD:1.5,contrastSensitivityPeak:60,contrastSlope:.85,temporalIntegrationMs:100,coneSensitivity:{L:.95,M:.85,S:.7},pupilDiameterMm:3.5,scatteringFactor:.1,accommodationRange:.6,centralFieldRadiusDeg:20,peripheralSuppression:.3,lateralInhibition:.7,photoreceptorNoise:.02,description:"Visual acuity 20/60 (4.0 cpd). Good color discrimination. Smooth pursuit tracking. Emerging stereopsis."}};function q(e,t,i,n,o){const r=e.getImageData(0,0,t,i),a=r.data;for(let s=0;s<a.length;s+=4){const f=a[s]/255,g=a[s+1]/255,B=a[s+2]/255,S=P(f),b=P(g),C=P(B),L=.2126*S+.7152*b+.0722*C;if(o===1){const y=S*n.coneSensitivity.L,m=L*.85,h=d(m+y*.25),O=d(m*n.coneSensitivity.M),V=d(m*n.coneSensitivity.S);a[s]=Math.round(l(h)*255),a[s+1]=Math.round(l(O)*255),a[s+2]=Math.round(l(V)*255)}else if(o===2){const y=d(S*n.coneSensitivity.L),m=d(b*n.coneSensitivity.M),h=d(Math.min(C*n.coneSensitivity.S,L*.3));a[s]=Math.round(l(y)*255),a[s+1]=Math.round(l(m)*255),a[s+2]=Math.round(l(h)*255)}else{const y=d(S*n.coneSensitivity.L),m=d(b*n.coneSensitivity.M),h=d(C*n.coneSensitivity.S);a[s]=Math.round(l(y)*255),a[s+1]=Math.round(l(m)*255),a[s+2]=Math.round(l(h)*255)}}e.putImageData(r,0,0)}function G(e,t,i,n){const o=t/2,r=i/2,a=H(t,i),s=Math.max(1,n.centralFieldRadiusDeg*a),f=Math.hypot(t,i)*.5;e.save(),e.globalCompositeOperation="multiply";const g=e.createRadialGradient(o,r,Math.max(1,s*.5),o,r,Math.max(s,f));g.addColorStop(0,"rgba(255,255,255,1)"),g.addColorStop(.5,`rgba(255,255,255,${1-n.peripheralSuppression*.4})`),g.addColorStop(1,`rgba(255,255,255,${1-n.peripheralSuppression})`),e.fillStyle=g,e.fillRect(0,0,t,i),e.restore()}const u=document.getElementById("cameraVideo"),p=document.getElementById("outputCanvas"),F=document.getElementById("infoPanel"),R=document.getElementById("mirrorToggle"),D=document.getElementById("peripheralBlurToggle");let c,v=1,w=!0,T=!0,M=0;function z(e,t){if(console.log("Setting up canvases with dimensions:",e,"x",t),e<=0||t<=0){console.error("Invalid canvas dimensions:",e,t);return}p.width=e,p.height=t,c=p.getContext("2d",{alpha:!1,willReadFrequently:!0}),console.log("Output canvas setup complete. Context:",c),["input","frequency","color","spatial","temporal","final"].forEach(n=>{const o=document.createElement("canvas");o.width=e,o.height=t,o.getContext("2d",{alpha:!1,willReadFrequently:!0})}),console.log("All processing canvases created")}function W(){if(!c){console.error("Output context not available");return}const e=p.width,t=p.height;if(e<=0||t<=0){console.error("Invalid canvas dimensions in processFrame:",e,t);return}if(!u||u.readyState<2){console.log("Video not ready, skipping frame");return}try{c.save(),w&&(c.translate(e,0),c.scale(-1,1)),c.drawImage(u,0,0,e,t),c.restore()}catch(o){console.error("Error drawing video to canvas:",o);return}const i=x[v],n=Math.max(0,(4-v)*2);n>0&&(c.save(),c.filter=`blur(${n}px) contrast(${i.contrastSensitivityPeak*2}%)`,c.drawImage(c.canvas,0,0),c.restore()),q(c,e,t,i,v),T&&G(c,e,t,i),M++,M===1&&console.log("First frame processed successfully!"),M%60===0&&console.log(`Raw camera feed - ${M} frames processed`)}function $(){W(),requestAnimationFrame($)}function E(){const e=x[v],t=`
    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
      <strong>Scientific Parameters:</strong><br>
      • Spatial cutoff: ${e.spatialCutoffCPD} cpd<br>
      • Contrast sensitivity: ${e.contrastSensitivityPeak}x<br>
      • Cone responses: L=${e.coneSensitivity.L}, M=${e.coneSensitivity.M}, S=${e.coneSensitivity.S}<br>
      • Optical scatter: ${(e.scatteringFactor*100).toFixed(0)}%<br>
      • Central field: ${e.centralFieldRadiusDeg}°
    </div>
  `;F.innerHTML=`
    <strong>${e.label}</strong>: ${e.description}
    ${t}
  `}async function _(){try{console.log("Requesting camera access...");const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}},audio:!1});console.log("Camera stream obtained:",e),u.srcObject=e,await new Promise(o=>{u.readyState>=2?(console.log("Video ready immediately"),o()):(console.log("Waiting for video metadata..."),u.onloadedmetadata=()=>{console.log("Video metadata loaded"),o()})}),console.log("Video dimensions:",u.videoWidth,"x",u.videoHeight),await u.play(),console.log("Video playing started");const t=p.parentElement,i=t.clientWidth,n=t.clientHeight;console.log("Container dimensions:",i,"x",n),z(i,n),E(),$(),console.log("Camera initialization complete")}catch(e){console.error("Camera error:",e),X(e)}}function U(){document.querySelectorAll('input[name="age"]').forEach(e=>{e.addEventListener("change",()=>{v=Number(e.value),E()})}),R.addEventListener("change",()=>{w=R.checked}),D.addEventListener("change",()=>{T=D.checked,E()})}function X(e){const t=document.createElement("div");t.style.background="rgba(255,0,0,0.08)",t.style.border="1px solid rgba(255,0,0,0.25)",t.style.padding="0.75rem",t.style.borderRadius="10px",t.style.marginTop="1rem",t.innerHTML=`
    <strong>Unable to access camera</strong><br>
    Please allow camera permissions and use a supported browser over HTTPS or localhost.<br>
    <small>Error: ${e.message}</small>
  `,F.replaceChildren(t),console.error("Camera error:",e)}function I(){const e=p.parentElement;if(!e)return;const t=e.getBoundingClientRect();p.style.width=t.width+"px",p.style.height=t.height+"px"}function Y(){U(),I(),window.addEventListener("resize",I),console.log("Advanced Baby Vision Simulator initialized"),console.log("Features: CSF-based spatial filtering, LMS color space, optical modeling"),console.log("Research basis: Contrast sensitivity development, cone maturation, optical properties"),_()}document.addEventListener("DOMContentLoaded",Y);
